name: Deploy Backend

on:
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  PYTHON_VERSION: '3.12'
  PROJECT_NAME: aml-faq-bot
  ENVIRONMENT: dev
  TF_VERSION: 1.9.0

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync

      - name: Verify imports
        env:
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          NVIDIA_MODEL_NAME: ${{ secrets.NVIDIA_MODEL_NAME }}
          NVIDIA_EMBEDDING_MODEL_NAME: ${{ secrets.NVIDIA_EMBEDDING_MODEL_NAME }}
          QDRANT_URL: ${{ secrets.QDRANT_URL }}
          QDRANT_API_KEY: ${{ secrets.QDRANT_API_KEY }}
        run: |
          uv run python -c "from app.main import app; print('FastAPI app OK')"
          uv run python -c "from handler import handler; print('Lambda handler OK')"

  build:
    name: Build Lambda Package
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}

      - name: Create deployment package
        run: |
          mkdir -p lambda_package
          
          # Install dependencies to lambda_package
          cd backend
          uv pip install --target ../lambda_package .
          
          # Copy application files
          cp -r app ../lambda_package/
          cp handler.py ../lambda_package/
          
          # Create zip (exclude unnecessary files to reduce size)
          cd ../lambda_package
          mkdir -p ../dist
          zip -rq ../dist/lambda.zip . \
            -x "*.pyc" \
            -x "*__pycache__*" \
            -x "*.dist-info/*" \
            -x "*.egg-info/*" \
            -x "tests/*" \
            -x "docs/*"
          
          # Show package size
          ls -lh ../dist/lambda.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package
          path: dist/lambda.zip
          retention-days: 7

  deploy:
    name: Deploy to Lambda
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: lambda-package
          path: dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Get Infrastructure Outputs
        id: infra
        working-directory: infrastructure/backend
        run: |
          terraform init -backend-config=backend.hcl
          echo "api_url=$(terraform output -raw api_gateway_url)" >> $GITHUB_OUTPUT
          echo "lambda_name=$(terraform output -raw lambda_function_name)" >> $GITHUB_OUTPUT
          echo "s3_bucket=$(terraform output -raw s3_bucket_name)" >> $GITHUB_OUTPUT

      - name: Deploy to Lambda
        run: |
          PACKAGE_SIZE=$(stat -c%s dist/lambda.zip)
          MAX_DIRECT_SIZE=52428800  # 50MB in bytes
          
          LAMBDA_NAME="${{ steps.infra.outputs.lambda_name }}"
          S3_BUCKET="${{ steps.infra.outputs.s3_bucket }}"
          
          if [ "$PACKAGE_SIZE" -gt "$MAX_DIRECT_SIZE" ]; then
            echo "Package size ($PACKAGE_SIZE bytes) exceeds 50MB, using S3 upload..."
            
            # Upload to S3
            aws s3 cp dist/lambda.zip s3://${S3_BUCKET}/deployments/lambda.zip
            
            # Deploy from S3
            aws lambda update-function-code \
              --function-name ${LAMBDA_NAME} \
              --s3-bucket ${S3_BUCKET} \
              --s3-key deployments/lambda.zip
          else
            echo "Package size ($PACKAGE_SIZE bytes), using direct upload..."
            aws lambda update-function-code \
              --function-name ${LAMBDA_NAME} \
              --zip-file fileb://dist/lambda.zip
          fi

      - name: Wait for update
        run: |
          aws lambda wait function-updated \
            --function-name ${{ steps.infra.outputs.lambda_name }}

      - name: Deployment Summary
        run: |
          echo "## âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Gateway URL (use for frontend)" >> $GITHUB_STEP_SUMMARY
          echo "**${{ steps.infra.outputs.api_url }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources" >> $GITHUB_STEP_SUMMARY
          echo "- Lambda: ${{ steps.infra.outputs.lambda_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- S3: ${{ steps.infra.outputs.s3_bucket }}" >> $GITHUB_STEP_SUMMARY
